#!/usr/bin/env python3
"""
–¢–µ—Å—Ç —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π –±–µ–∑ –∫–Ω–æ–ø–∫–∏ '–û –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è—Ö'
"""
import logging
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def test_streamlined_donations():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —É–ø—Ä–æ—â–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π"""
    
    logger.info("üß™ –¢–µ—Å—Ç —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π...")
    logger.info("=" * 60)
    
    try:
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π
        logger.info("1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π...")
        
        from keyboards.settings import create_donation_keyboard
        
        keyboard = create_donation_keyboard()
        button_count = sum(len(row) for row in keyboard.inline_keyboard)
        
        logger.info(f"   ‚úÖ –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π: {button_count} –∫–Ω–æ–ø–æ–∫")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫–∏
        buttons_info = []
        info_button_found = False
        
        for row in keyboard.inline_keyboard:
            for button in row:
                if hasattr(button, 'url') and button.url:
                    buttons_info.append(f"{button.text} ‚Üí {button.url}")
                else:
                    buttons_info.append(f"{button.text} ‚Üí {button.callback_data}")
                    
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–Ω–æ–ø–∫–∞ "–û –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è—Ö"
                if "–û –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è—Ö" in button.text:
                    info_button_found = True
        
        logger.info("   üìã –ö–Ω–æ–ø–∫–∏:")
        for button_info in buttons_info:
            logger.info(f"      ‚Ä¢ {button_info}")
        
        if not info_button_found:
            logger.info("   ‚úÖ –ö–Ω–æ–ø–∫–∞ '–û –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è—Ö' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞")
        else:
            logger.error("   ‚ùå –ö–Ω–æ–ø–∫–∞ '–û –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è—Ö' –≤—Å–µ –µ—â–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º YooMoney —Å—Å—ã–ª–∫—É
        yoomoney_found = False
        stars_found = False
        
        for row in keyboard.inline_keyboard:
            for button in row:
                if hasattr(button, 'url') and button.url and 'yoomoney.ru' in button.url:
                    yoomoney_found = True
                    logger.info(f"   ‚úÖ YooMoney —Å—Å—ã–ª–∫–∞: {button.url}")
                elif "Telegram Stars" in button.text:
                    stars_found = True
                    logger.info(f"   ‚úÖ Telegram Stars –∫–Ω–æ–ø–∫–∞: {button.text}")
        
        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
        logger.info("2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é...")
        
        # –ò–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
        main_menu_text = (
            "üíù **–ü–æ–º–æ—á—å –ø—Ä–æ–µ–∫—Ç—É**\n\n"
            "üéØ **–¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞:**\n"
            "–°–æ–∑–¥–∞—Ç—å –ª—É—á—à–µ–≥–æ –±–∏–±–ª–µ–π—Å–∫–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞ —Å –ò–ò –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –°–≤—è—â–µ–Ω–Ω–æ–≥–æ –ü–∏—Å–∞–Ω–∏—è.\n\n"
            "üí∞ **–°–ø–æ—Å–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏:**\n"
            "‚Ä¢ üåü **Telegram Stars** - –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ –ø—Ä—è–º–æ –≤ –±–æ—Ç–µ\n"
            "‚Ä¢ üí∞ **YooMoney** - –ª—é–±—ã–µ –∫–∞—Ä—Ç—ã (Visa, MasterCard, –ú–ò–†)\n"
            "‚Ä¢ üí≥ **–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã** - –ø—Ä—è–º—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã\n\n"
            "üè¶ **–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤:**\n"
            "‚Ä¢ **–°–±–µ—Ä–±–∞–Ω–∫:** `5469 4800 1497 4056`\n"
            "‚Ä¢ **–¢-–±–∞–Ω–∫:** `5536 9138 1011 4583`\n"
            "‚Ä¢ **–ü–æ–ª—É—á–∞—Ç–µ–ª—å:** –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω –ù–∏–∫–æ–ª–∞–µ–≤–∏—á –ë.\n"
            "‚Ä¢ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Gospel Bot\n\n"
            "üôè **–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å:**\n"
            "–ö–∞–∂–¥–æ–µ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç:\n"
            "‚Ä¢ –û–ø–ª–∞—á–∏–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä—ã –∏ API\n"
            "‚Ä¢ –†–∞–∑–≤–∏–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\n"
            "‚Ä¢ –£–ª—É—á—à–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –ò–ò –æ—Ç–≤–µ—Ç–æ–≤\n"
            "‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º –¥–ª—è –≤—Å–µ—Ö\n\n"
            "üìñ **–°–ª–æ–≤–æ –ë–æ–∂–∏–µ –æ –º–∏–ª–æ—Å—Ç—ã–Ω–µ:**\n\n"
            "*\"–ë–ª–∞–∂–µ–Ω–Ω—ã –º–∏–ª–æ—Å—Ç–∏–≤—ã–µ, –∏–±–æ –æ–Ω–∏ –ø–æ–º–∏–ª–æ–≤–∞–Ω—ã –±—É–¥—É—Ç\"*\n"
            "‚Äî –ú–∞—Ç—Ñ–µ—è 5:7\n\n"
            "*\"–î–∞–≤–∞–π—Ç–µ, –∏ –¥–∞—Å—Ç—Å—è –≤–∞–º: –º–µ—Ä–æ—é –¥–æ–±—Ä–æ—é, —É—Ç—Ä—è—Å–µ–Ω–Ω–æ—é, –Ω–∞–≥–Ω–µ—Ç–µ–Ω–Ω–æ—é –∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–Ω–æ—é –æ—Ç—Å—ã–ø–ª—é—Ç –≤–∞–º –≤ –ª–æ–Ω–æ –≤–∞—à–µ\"*\n"
            "‚Äî –õ—É–∫–∏ 6:38\n\n"
            "*\"–ö—Ç–æ –¥–∞–µ—Ç –Ω–∏—â–µ–º—É, —Ç–æ—Ç –Ω–µ –æ–±–µ–¥–Ω–µ–µ—Ç; –∞ –∫—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≥–ª–∞–∑–∞ —Å–≤–æ–∏, –Ω–∞ —Ç–æ–º –º–Ω–æ–≥–æ –ø—Ä–æ–∫–ª—è—Ç–∏–π\"*\n"
            "‚Äî –ü—Ä–∏—Ç—á–∏ 28:27\n\n"
            "üíù **–û—Ç —Å–µ—Ä–¥—Ü–∞:**\n"
            "–í–∞—à–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ - —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –¥–µ–Ω—å–≥–∏, —ç—Ç–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ –¥—É—Ö–æ–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ —Ç—ã—Å—è—á –ª—é–¥–µ–π, –∏–∑—É—á–∞—é—â–∏—Ö –°–≤—è—â–µ–Ω–Ω–æ–µ –ü–∏—Å–∞–Ω–∏–µ.\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–¥–¥–µ—Ä–∂–∫–∏:"
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        components_check = {
            "–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã": "5469 4800 1497 4056" in main_menu_text and "5536 9138 1011 4583" in main_menu_text,
            "–ü–æ–ª—É—á–∞—Ç–µ–ª—å": "–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω –ù–∏–∫–æ–ª–∞–µ–≤–∏—á –ë." in main_menu_text,
            "–¶–∏—Ç–∞—Ç–∞ –ú–∞—Ç—Ñ–µ—è 5:7": "–ë–ª–∞–∂–µ–Ω–Ω—ã –º–∏–ª–æ—Å—Ç–∏–≤—ã–µ" in main_menu_text,
            "–¶–∏—Ç–∞—Ç–∞ –õ—É–∫–∏ 6:38": "–î–∞–≤–∞–π—Ç–µ, –∏ –¥–∞—Å—Ç—Å—è –≤–∞–º" in main_menu_text,
            "–¶–∏—Ç–∞—Ç–∞ –ü—Ä–∏—Ç—á–∏ 28:27": "–ö—Ç–æ –¥–∞–µ—Ç –Ω–∏—â–µ–º—É" in main_menu_text,
            "–¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞": "–±–∏–±–ª–µ–π—Å–∫–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞" in main_menu_text,
            "–°–ø–æ—Å–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏": "Telegram Stars" in main_menu_text and "YooMoney" in main_menu_text
        }
        
        for component, status in components_check.items():
            if status:
                logger.info(f"   ‚úÖ {component} –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
            else:
                logger.error(f"   ‚ùå {component} –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
        
        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        logger.info("3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫...")
        
        try:
            from handlers.settings import settings_donation, show_donation_menu_from_main
            logger.info("   ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ settings_donation –Ω–∞–π–¥–µ–Ω")
            logger.info("   ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ show_donation_menu_from_main –Ω–∞–π–¥–µ–Ω")
            handlers_ok = True
        except ImportError as e:
            logger.error(f"   ‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤: {e}")
            handlers_ok = False
        
        # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        logger.info("4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é...")
        
        try:
            from keyboards.main import get_main_keyboard
            import asyncio
            
            async def check_main_menu():
                main_keyboard = await get_main_keyboard()
                main_buttons = []
                for row in main_keyboard.keyboard:
                    for button in row:
                        main_buttons.append(button.text)
                
                help_project_found = any("–ü–æ–º–æ—á—å –ø—Ä–æ–µ–∫—Ç—É" in button for button in main_buttons)
                return help_project_found, len(main_buttons)
            
            help_found, main_button_count = asyncio.run(check_main_menu())
            
            logger.info(f"   ‚úÖ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é: {main_button_count} –∫–Ω–æ–ø–æ–∫")
            if help_found:
                logger.info("   ‚úÖ –ö–Ω–æ–ø–∫–∞ '–ü–æ–º–æ—á—å –ø—Ä–æ–µ–∫—Ç—É' –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é")
            else:
                logger.error("   ‚ùå –ö–Ω–æ–ø–∫–∞ '–ü–æ–º–æ—á—å –ø—Ä–æ–µ–∫—Ç—É' –ù–ï –Ω–∞–π–¥–µ–Ω–∞ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é")
            
        except Exception as e:
            logger.error(f"   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é: {e}")
            help_found = False
        
        # 5. –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞
        logger.info("5Ô∏è‚É£ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞...")
        
        evaluation_components = {
            "–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–ø—Ä–æ—â–µ–Ω–∞": not info_button_found,
            "YooMoney —Å—Å—ã–ª–∫–∞": yoomoney_found,
            "Telegram Stars": stars_found,
            "–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã": components_check["–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã"],
            "–ë–∏–±–ª–µ–π—Å–∫–∏–µ —Ü–∏—Ç–∞—Ç—ã": components_check["–¶–∏—Ç–∞—Ç–∞ –ú–∞—Ç—Ñ–µ—è 5:7"] and components_check["–¶–∏—Ç–∞—Ç–∞ –õ—É–∫–∏ 6:38"],
            "–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏": handlers_ok,
            "–ö–Ω–æ–ø–∫–∞ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é": help_found,
            "–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è": all(components_check.values())
        }
        
        success_count = sum(evaluation_components.values())
        total_count = len(evaluation_components)
        
        logger.info(f"   üìä –û—Ü–µ–Ω–∫–∞: {success_count}/{total_count}")
        
        for component, status in evaluation_components.items():
            status_icon = "‚úÖ" if status else "‚ùå"
            logger.info(f"   {status_icon} {component}")
        
        if success_count >= 7:
            logger.info("üéâ –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π –≥–æ—Ç–æ–≤–∞!")
        else:
            logger.warning("‚ö†Ô∏è –¢—Ä–µ–±—É—é—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∏")
        
        # 6. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —É–ø—Ä–æ—â–µ–Ω–∏—è
        logger.info("6Ô∏è‚É£ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —É–ø—Ä–æ—â–µ–Ω–∏—è:")
        logger.info("   üí° –£–±—Ä–∞–Ω–∞ –ª–∏—à–Ω—è—è –∫–Ω–æ–ø–∫–∞ '–û –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è—Ö'")
        logger.info("   üí° –í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É")
        logger.info("   üí° –ú–µ–Ω—å—à–µ –∫–ª–∏–∫–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
        logger.info("   üí° –ë–æ–ª–µ–µ –ø—Ä—è–º–æ–π –ø—É—Ç—å –∫ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è–º")
        logger.info("   üí° –ë–∏–±–ª–µ–π—Å–∫–∏–µ —Ü–∏—Ç–∞—Ç—ã –≤–∏–¥–Ω—ã —Å—Ä–∞–∑—É")
        logger.info("   üí° –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Å—Ä–∞–∑—É")
        
        # 7. –°–ø–æ—Å–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
        logger.info("7Ô∏è‚É£ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏:")
        logger.info("   üåü Telegram Stars - –±—ã—Å—Ç—Ä–æ –≤ –±–æ—Ç–µ")
        logger.info("   üí∞ YooMoney - https://yoomoney.ru/to/4100119287537792")
        logger.info("   üí≥ –°–±–µ—Ä–±–∞–Ω–∫ - 5469 4800 1497 4056")
        logger.info("   üí≥ –¢-–±–∞–Ω–∫ - 5536 9138 1011 4583")
        logger.info("   üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å - –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω –ù–∏–∫–æ–ª–∞–µ–≤–∏—á –ë.")
        
        logger.info("üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    test_streamlined_donations()