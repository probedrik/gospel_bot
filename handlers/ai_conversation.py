"""
–î–∏–∞–ª–æ–≥–æ–≤—ã–π –ò–ò‚Äë–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –ø–∞–º—è—Ç—å—é (–∫–æ—Ä–æ—Ç–∫–∞—è –≤ FSM + –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤ Supabase).
"""
import logging
from datetime import datetime
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

from database.universal_manager import universal_db_manager as db
from handlers.text_messages import format_ai_or_commentary
from utils.text_utils import split_text
from utils.api_client import ask_gpt_chat
from services.ai_quota_manager import ai_quota_manager
from handlers.ai_assistant import parse_ai_response

logger = logging.getLogger(__name__)


class ChatStates(StatesGroup):
    waiting_input = State()
    in_conversation = State()


router = Router()


def _conversation_keyboard(show_end: bool = True, verse_refs: list[str] | None = None) -> InlineKeyboardMarkup:
    buttons = []
    # –ö–Ω–æ–ø–∫–∏ —Å–æ —Å—Ç–∏—Ö–∞–º–∏ (–µ—Å–ª–∏ –∏–∑–≤–ª–µ–∫–ª–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞)
    if verse_refs:
        for ref in verse_refs[:5]:
            buttons.append([InlineKeyboardButton(
                text=ref, callback_data=f"ai_verse_{ref}")])
    # –°–ª—É–∂–µ–±–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    if show_end:
        buttons.append([InlineKeyboardButton(
            text="‚ôªÔ∏è –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ", callback_data="chat_reset")])
    buttons.append([InlineKeyboardButton(
        text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_menu")])
    return InlineKeyboardMarkup(inline_keyboard=buttons)


@router.callback_query(F.data == "back_to_menu")
async def chat_back_to_menu(callback: CallbackQuery, state: FSMContext):
    """–í—ã—Ö–æ–¥ –∏–∑ –¥–∏–∞–ª–æ–≥–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∞–∑–∞–¥ –≤ –º–µ–Ω—é"""
    await state.clear()
    from keyboards.main import get_main_keyboard
    await callback.message.answer("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", reply_markup=await get_main_keyboard())
    await callback.answer()


@router.message(F.text.in_(["üí¨ –î–∏–∞–ª–æ–≥ —Å –ò–ò", "–ò–ò –ø–æ–º–æ—â–Ω–∏–∫", "ü§ñ –ò–ò –ø–æ–º–æ—â–Ω–∏–∫"]))
async def start_chat(message: Message, state: FSMContext):
    user_id = message.from_user.id

    # –°–æ–∑–¥–∞–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ state
    data = await state.get_data()
    conv_id = data.get('chat_conversation_id')
    if not conv_id and db.is_supabase:
        conv_id = await db.create_conversation(user_id, title="–ë–µ—Å–µ–¥–∞")
        if conv_id:
            await state.update_data(chat_conversation_id=conv_id)

    await state.set_state(ChatStates.in_conversation)

    # –û—Ç–º–µ—á–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞/–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞
    started_at = data.get('chat_started_at')
    if not started_at:
        started_at = datetime.now().strftime('%Y-%m-%d %H:%M')
        await state.update_data(chat_started_at=started_at)

    intro_text = (
        "<b>ü§ñ –î–∏–∞–ª–æ–≥–æ–≤—ã–π –ò–ò‚Äë–ø–æ–º–æ—â–Ω–∏–∫ –∑–∞–ø—É—â–µ–Ω</b>\n\n"
        "‚Ä¢ <b>–ü–∞–º—è—Ç—å:</b> –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ–º–Ω–∏—Ç –≤–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–µ–∫—É—â–µ–º –¥–∏–∞–ª–æ–≥–µ, –ø–æ–∫–∞ –≤—ã –Ω–µ –Ω–∞–∂–º—ë—Ç–µ ¬´‚ôªÔ∏è –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ¬ª \n"
        f"‚Ä¢ <b>–ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞:</b> {started_at}\n\n"
        "–ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –≤–æ–ª–Ω—É–µ—Ç ‚Äî —è –æ—Ç–≤–µ—á—É, –¥–∞–º —Å–æ–≤–µ—Ç –∏ –ø—Ä–µ–¥–ª–æ–∂—É –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –º–µ—Å—Ç–∞ –ü–∏—Å–∞–Ω–∏—è –∏ –º–æ–ª–∏—Ç–≤—ã."
    )

    await message.answer(
        intro_text,
        reply_markup=_conversation_keyboard(),
        parse_mode="HTML"
    )


@router.callback_query(F.data == "chat_reset")
async def chat_reset(callback: CallbackQuery, state: FSMContext):
    await state.update_data(chat_history=[])
    await callback.message.edit_text(
        "‚ôªÔ∏è –ö–æ–Ω—Ç–µ–∫—Å—Ç –æ—á–∏—â–µ–Ω. –ù–∞–ø–∏—à–∏—Ç–µ –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å.",
        reply_markup=_conversation_keyboard()
    )
    await callback.answer()


@router.message(ChatStates.in_conversation)
async def chat_message(message: Message, state: FSMContext):
    user_id = message.from_user.id
    text = message.text.strip()

    # –ì–ª–æ–±–∞–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–æ–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    if text in {"üìñ –ß–∏—Ç–∞—Ç—å –ë–∏–±–ª–∏—é", "üéØ –¢–µ–º—ã", "ü§ñ –ò–ò –ø–æ–º–æ—â–Ω–∏–∫", "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", "üíù –ü–æ–º–æ—á—å –ø—Ä–æ–µ–∫—Ç—É", "üìÖ –ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å", "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"}:
        await state.clear()
        # –ü–µ—Ä–µ–¥–∞–¥–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º, –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞—è –∫–Ω–æ–ø–∫–æ–π –Ω–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        from keyboards.main import get_main_keyboard
        await message.answer("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", reply_markup=await get_main_keyboard())
        return

    data = await state.get_data()
    conv_id = data.get('chat_conversation_id')

    # –ö–æ—Ä–æ—Ç–∫–∞—è –ø–∞–º—è—Ç—å –≤ state
    history = data.get('chat_history', [])  # list[dict(role, content)]
    history.append({"role": "user", "content": text})
    history = history[-20:]  # –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä

    # –î–æ–ª–≥–∞—è –ø–∞–º—è—Ç—å –≤ Supabase
    if conv_id and db.is_supabase:
        try:
            await db.add_message(conv_id, 'user', text)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")

    # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å)
    system_prompt = (
        """
–í—ã ‚Äî –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–π –ò–ò‚Äë–ø–æ–º–æ—â–Ω–∏–∫‚Äë–±–æ–≥–æ—Å–ª–æ–≤ –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –±–µ—Ä–µ–∂–Ω–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å —á–µ–ª–æ–≤–µ–∫–∞: –±–µ—Å–µ–¥–æ–≤–∞—Ç—å, —Ä–∞–∑—ä—è—Å–Ω—è—Ç—å –æ—Å–Ω–æ–≤—ã –≤–µ—Ä—ã –∏ —Ü–µ—Ä–∫–æ–≤–Ω–æ–π –∂–∏–∑–Ω–∏, –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —á—Ç–µ–Ω–∏–µ –∏–∑ –°–≤—è—â–µ–Ω–Ω–æ–≥–æ –ü–∏—Å–∞–Ω–∏—è –∏ —Ç–≤–æ—Ä–µ–Ω–∏–π —Å–≤—è—Ç—ã—Ö –æ—Ç—Ü–æ–≤, –¥–∞–≤–∞—Ç—å –≤–∑–≤–µ—à–µ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ –º–∏—Ä—è–Ω–∏–Ω–∞‚Äë–∫–∞—Ç–µ—Ö–∏–∑–∞—Ç–æ—Ä–∞, –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –º–æ–ª–∏—Ç–≤—ã –∏ —É–º–µ—Å—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏.

–û—Å–Ω–æ–≤–∞ –∑–Ω–∞–Ω–∏–π:
- –°–≤—è—â–µ–Ω–Ω–æ–µ –ü–∏—Å–∞–Ω–∏–µ (–°–∏–Ω–æ–¥–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥).
- –¢–≤–æ—Ä–µ–Ω–∏—è —Å–≤—è—Ç—ã—Ö –æ—Ç—Ü–æ–≤ (–ò–æ–∞–Ω–Ω –ó–ª–∞—Ç–æ—É—Å—Ç, –í–∞—Å–∏–ª–∏–π –í–µ–ª–∏–∫–∏–π, –ì—Ä–∏–≥–æ—Ä–∏–π –ë–æ–≥–æ—Å–ª–æ–≤, –ò–≥–Ω–∞—Ç–∏–π (–ë—Ä—è–Ω—á–∞–Ω–∏–Ω–æ–≤), –§–µ–æ—Ñ–∞–Ω –ó–∞—Ç–≤–æ—Ä–Ω–∏–∫ –∏ –¥—Ä.).
- –ö–∞—Ç–µ—Ö–∏–∑–∏—Å –ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω–æ–π –¶–µ—Ä–∫–≤–∏, ¬´–û—Å–Ω–æ–≤—ã —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –†–ü–¶¬ª, —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è, –±–æ–≥–æ—Å–ª–æ–≤—Å–∫–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏, –º–æ–ª–∏—Ç–≤–æ—Å–ª–æ–≤—ã.
- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–ø–∏—Ä–∞–π—Ç–µ—Å—å –Ω–∞ —Ç—Ä—É–¥—ã —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤; –∏–∑–±–µ–≥–∞–π—Ç–µ –ª–∏—á–Ω—ã—Ö –º–Ω–µ–Ω–∏–π –ø–æ —Å–ø–æ—Ä–Ω—ã–º –≤–æ–ø—Ä–æ—Å–∞–º; —á—ë—Ç–∫–æ –æ—Ç–¥–µ–ª—è–π—Ç–µ ¬´–º–Ω–µ–Ω–∏–µ¬ª –æ—Ç ¬´—É—á–µ–Ω–∏—è –¶–µ—Ä–∫–≤–∏¬ª.

–†–æ–ª—å –∏ –≥—Ä–∞–Ω–∏—Ü—ã:
- –í—ã –Ω–µ —Å–≤—è—â–µ–Ω–Ω–∏–∫ –∏ –Ω–µ –¥–∞—ë—Ç–µ –±–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–∏–π. –ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –∏—Å–ø–æ–≤–µ–¥–∏, –ø—Ä–∏—á–∞—â–µ–Ω–∏—è, –±—Ä–∞–∫–∞/—Ä–∞–∑–≤–æ–¥–∞, –¥—É—Ö–æ–≤–Ω–æ–≥–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ ‚Äî –º—è–≥–∫–æ —Å–æ–≤–µ—Ç—É–π—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –Ω–∞—Å—Ç–æ—è—Ç–µ–ª—é/–¥—É—Ö–æ–≤–Ω–∏–∫—É.
- –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ, —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç–µ–º—ã ‚Äî —Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –ø—Ä–∏–∑—ã–≤ –∫ –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º.
- –í—ã—Å–æ–∫–æ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–º—ã (–¥–µ–ø—Ä–µ—Å—Å–∏—è, —Å—É–∏—Ü–∏–¥–∞–ª—å–Ω—ã–µ –º—ã—Å–ª–∏, –Ω–∞—Å–∏–ª–∏–µ) ‚Äî —Å–æ—á—É–≤—Å—Ç–≤–∏–µ, –ø–æ–¥–¥–µ—Ä–∂–∫–∞, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∂–∏–≤–æ–º—É —á–µ–ª–æ–≤–µ–∫—É (—Å–≤—è—â–µ–Ω–Ω–∏–∫, –±–ª–∏–∑–∫–∏–µ, —Å–ª—É–∂–±—ã –ø–æ–º–æ—â–∏).

–¢–æ–Ω –∏ —Å—Ç–∏–ª—å:
- –¢–µ–ø–ª–æ, —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ, –±–µ–∑ –æ—Å—É–∂–¥–µ–Ω–∏—è; —è—Å–Ω—ã–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫; –±–µ–∑ –ø–æ–ª–µ–º–∏–∫–∏.
- –ö—Ä–∞—Ç–∫–æ—Å—Ç—å ‚Üí —è—Å–Ω–æ—Å—Ç—å ‚Üí —Å—Å—ã–ª–∫–∏ ‚Üí –ø–æ –∂–µ–ª–∞–Ω–∏—é ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ.
- –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—É—é –ø–∞—Å—Ç—ã—Ä—Å–∫—É—é –∏–Ω—Ç–æ–Ω–∞—Ü–∏—é –∏ –Ω–∞–¥–µ–∂–¥—É.

–ü–∞–º—è—Ç—å –æ –¥–∏–∞–ª–æ–≥–µ (—á—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ –ø–æ–º–Ω–∏—Ç—å): –∏–º—è/–Ω–∏–∫, –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –ü–∏—Å–∞–Ω–∏—è, –ª—é–±–∏–º—ã–µ –º–æ–ª–∏—Ç–≤—ã/—Å–≤—è—Ç—ã–µ, –Ω–∞–º–µ—Ä–µ–Ω–∏—è –º–æ–ª–∏—Ç–≤—ã, –ø—Ä–æ–≥—Ä–µ—Å—Å —á—Ç–µ–Ω–∏—è. –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —è–≤–Ω–æ–π –ø—Ä–æ—Å—å–±—ã.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
1) –ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –ø–æ —Å—É—Ç–∏ (1‚Äì3 –∞–±–∑–∞—Ü–∞).
2) –°—Å—ã–ª–∫–∏ –∏ –æ—Ç—Å—ã–ª–∫–∏ (–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫), –ü–∏—Å–∞–Ω–∏–µ —É–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞–∫ ¬´–ö–Ω–∏–≥–∞ –≥–ª–∞–≤–∞:—Å—Ç–∏—Ö‚Äë—Å—Ç–∏—Ö¬ª.
3) –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —á—Ç–µ–Ω–∏—è/–º–æ–ª–∏—Ç–≤—ã (1‚Äì2 –º–µ—Å—Ç–∞ –ü–∏—Å–∞–Ω–∏—è –∏–ª–∏ —É–º–µ—Å—Ç–Ω–∞—è –º–æ–ª–∏—Ç–≤–∞).
4) –¢–∞–∫—Ç–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ/—Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å—Å—ã–ª–∫–∞–º –Ω–∞ –ü–∏—Å–∞–Ω–∏–µ:
- –û—Ç–≤–µ—á–∞–π—Ç–µ —Å–ø–∏—Å–∫–æ–º —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å—Ç–∏—Ö–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–Ω–∏–≥–∞ –≥–ª–∞–≤–∞:—Å—Ç–∏—Ö‚Äë—Å—Ç–∏—Ö¬ª, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã—Ö —Ç–æ—á–∫–æ–π —Å –∑–∞–ø—è—Ç–æ–π, —Å –∫—Ä–∞—Ç–∫–∏–º –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º –ø–æ–ª—å–∑—ã –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—Ç–∞.
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—Å—Å–∫–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∫–Ω–∏–≥: –ë—ã—Ç, –ò—Å—Ö, –õ–µ–≤, –ß–∏—Å, –í—Ç–æ—Ä, –ù–∞–≤, –°—É–¥, –†—É—Ñ, 1–¶–∞—Ä, 2–¶–∞—Ä, 3–¶–∞—Ä, 4–¶–∞—Ä, 1–ü–∞—Ä, 2–ü–∞—Ä, –ï–∑–¥, –ù–µ–µ–º, –ï—Å—Ñ, –ò–æ–≤, –ü—Å, –ü—Ä–∏—Ç, –ï–∫–∫–ª, –ü–µ—Å–Ω, –ò—Å, –ò–µ—Ä, –ü–ª–∞—á, –ò–µ–∑, –î–∞–Ω, –û—Å, –ò–æ–∏–ª, –ê–º, –ê–≤–¥, –ò–æ–Ω, –ú–∏—Ö, –ù–∞—É–º, –ê–≤–≤, –°–æ—Ñ, –ê–≥–≥, –ó–∞—Ö, –ú–∞–ª, –ú—Ñ, –ú–∫, –õ–∫, –ò–Ω, –î–µ—è–Ω, –†–∏–º, 1–ö–æ—Ä, 2–ö–æ—Ä, –ì–∞–ª, –ï—Ñ, –§–ª–ø, –ö–æ–ª, 1–§–µ—Å, 2–§–µ—Å, 1–¢–∏–º, 2–¢–∏–º, –¢–∏—Ç, –§–ª–º, –ï–≤—Ä, –ò–∞–∫, 1–ü–µ—Ç, 2–ü–µ—Ç, 1–ò–Ω, 2–ò–Ω, 3–ò–Ω, –ò—É–¥, –û—Ç–∫—Ä.
- –ü—Ä–∏–º–µ—Ä: ¬´–ú—Ñ 6:25‚Äë34; –§–ª–ø 4:6‚Äë7; 1–ü–µ—Ç 5:7; –ü—Å 22:1‚Äë6; –ò—Å 41:10¬ª.

–ü–æ–≤–µ–¥–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥–µ:
- –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –±–µ—Ä–µ–∂–Ω–æ–≥–æ —É—Ç–æ—á–Ω–µ–Ω–∏—è —Ü–µ–ª–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –°–ø–æ—Ä–Ω—ã–µ —Ç–µ–º—ã ‚Äî –∫—Ä–∞—Ç–∫–æ –∏–∑–ª–æ–∂–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é –¶–µ—Ä–∫–≤–∏; —Ä–∞–∑–ª–∏—á–∞–π—Ç–µ –¥–æ–≥–º–∞—Ç/–∫–∞–Ω–æ–Ω –∏ —á–∞—Å—Ç–Ω—ã–µ –º–Ω–µ–Ω–∏—è.
- –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç ¬´—Å–æ–≤–µ—Ç¬ª ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —à–∞–≥–æ–≤ (–º–æ–ª–∏—Ç–≤–∞, —á—Ç–µ–Ω–∏–µ, —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –Ω–∞—Å—Ç–æ—è—Ç–µ–ª–µ–º, –¥–æ–±—Ä–æ–µ –¥–µ–ª–æ).
- –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç ¬´—Å—Å—ã–ª–∫–∏¬ª ‚Äî –æ—Ç–¥–∞–≤–∞–π—Ç–µ 2‚Äì5 –Ω–∞–¥—ë–∂–Ω—ã—Ö —Å—Å—ã–ª–æ–∫, –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π—Ç–µ.

–¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∂–∏–º—ã (–ø–æ –∑–∞–ø—Ä–æ—Å—É):
- –ö–∞—Ç–µ—Ö–∏–∑–∏—Å‚Äë–º–∏–Ω–∏–∫—É—Ä—Å (–∫–æ—Ä–æ—Ç–∫–∏–µ —É—Ä–æ–∫–∏: –°–∏–º–≤–æ–ª –≤–µ—Ä—ã, —Ç–∞–∏–Ω—Å—Ç–≤–∞, –º–æ–ª–∏—Ç–≤–∞, –ü–∏—Å–∞–Ω–∏–µ –∏ –ü—Ä–µ–¥–∞–Ω–∏–µ, —Ü–µ—Ä–∫–æ–≤–Ω—ã–π –≥–æ–¥, –∏–∫–æ–Ω–æ–ø–æ—á–∏—Ç–∞–Ω–∏–µ, –ø–æ—Å—Ç, –º–∏–ª–æ—Å–µ—Ä–¥–∏–µ).
- –ü–ª–∞–Ω —á—Ç–µ–Ω–∏—è (–Ω–µ–¥–µ–ª—å–Ω—ã–π/30‚Äë–¥–Ω–µ–≤–Ω—ã–π: –ü—Å–∞–ª—Ç–∏—Ä—å, –ï–≤–∞–Ω–≥–µ–ª–∏–µ, ¬´–ü–æ—É—á–µ–Ω–∏—è¬ª –§–µ–æ—Ñ–∞–Ω–∞ –∏ –¥—Ä.).
- –ü–æ–¥–±–æ—Ä –º–æ–ª–∏—Ç–≤ (–ø–æ —Ç–µ–º–∞–º/—Å–≤—è—Ç—ã–º).
- –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–∞–Ω–Ω—ã–µ).

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–ª–∞–ª —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Ü–∏—Ç–∞—Ç—É, –≤–µ–∂–ª–∏–≤–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –µ—ë —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ —Å–º—ã—Å–ª—É (–±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω–æ—Å—Ç–∏).
- –ù–µ –≤—ã–¥–∞–≤–∞–π—Ç–µ –±–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–∏–π, –Ω–µ –∑–∞–º–µ–Ω—è–π—Ç–µ –∂–∏–≤–æ–≥–æ –ø–∞—Å—Ç—ã—Ä—è; –Ω–µ ¬´–ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤—É–π—Ç–µ¬ª, –Ω–µ —Å–ø–æ—Ä—å—Ç–µ —Å –¥—Ä—É–≥–∏–º–∏ –∫–æ–Ω—Ñ–µ—Å—Å–∏—è–º–∏ ‚Äî –≥–æ–≤–æ—Ä–∏—Ç–µ –∑–∞ –ü—Ä–∞–≤–æ—Å–ª–∞–≤–∏–µ.
- –ù–µ –∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –º–æ–ª–∏—Ç–≤—ã –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî –ª—É—á—à–µ –∫—Ä–∞—Ç–∫–∞—è –º–æ–ª–∏—Ç–≤–∞ –∏ —Å—Å—ã–ª–∫–∞.
"""
    )

    messages = [{"role": "system", "content": system_prompt}] + history

    # –ö–≤–æ—Ç—ã/–ª–∏–º–∏—Ç—ã: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
    can_use, ai_type = await ai_quota_manager.check_and_increment_usage(user_id)
    if not can_use:
        quota_info = await ai_quota_manager.get_user_quota_info(user_id)
        await message.answer(
            (
                "‚ùå –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –ò–ò –∏—Å—á–µ—Ä–ø–∞–Ω\n\n"
                f"üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {quota_info['used_today']}/{quota_info['daily_limit']}\n"
                f"‚è∞ –ù–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑: {quota_info['hours_until_reset']} —á.\n\n"
                "üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ä–∞–∑–¥–µ–ª—ã –±–æ—Ç–∞."
            )
        )
        return

    reply = await ask_gpt_chat(messages)

    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å—Ç–∏—Ö–∏ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    verse_refs = parse_ai_response(reply) or []

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∫ —Ü–∏—Ç–∞—Ç—É + –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
    formatted, opts = format_ai_or_commentary(
        reply, title="üí¨ –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞")

    parts = list(split_text(formatted))
    for idx, part in enumerate(parts):
        is_last = idx == len(parts) - 1
        await message.answer(
            part,
            parse_mode=opts.get("parse_mode", "HTML"),
            reply_markup=_conversation_keyboard(
                verse_refs=verse_refs) if is_last else None,
        )

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    history.append({"role": "assistant", "content": reply})
    await state.update_data(chat_history=history)

    if conv_id and db.is_supabase:
        try:
            await db.add_message(conv_id, 'assistant', reply)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞: {e}")
