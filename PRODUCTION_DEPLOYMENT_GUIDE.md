# ðŸš€ Ð ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ð¾ Ð¿Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÑƒ Ð±Ð¾Ñ‚Ð° Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½

## ðŸ“‹ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ
1. [ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° VPS](#Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ°-vps)
2. [ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Supabase RLS](#Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°-supabase-rls)
3. [ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð±Ð¾Ñ‚Ð°](#ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ-Ð±Ð¾Ñ‚Ð°)
4. [ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸](#Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°-ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸)
5. [ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¸ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ](#Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³-Ð¸-Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ)
6. [Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ](#Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ-ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ)
7. [Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ](#Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ)

---

# ðŸ–¥ï¸ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° VPS

## ðŸ”§ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ
- **ÐžÐ¡**: Ubuntu 20.04+ Ð¸Ð»Ð¸ CentOS 8+
- **RAM**: ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ 1GB, Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ 2GB+
- **CPU**: 1 vCPU (Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð»Ñ ÑÑ‚Ð°Ñ€Ñ‚Ð°)
- **Ð”Ð¸ÑÐº**: 20GB+ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¼ÐµÑÑ‚Ð°
- **Ð¡ÐµÑ‚ÑŒ**: Ð¡Ñ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚-ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ

## ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹

```bash
# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
sudo apt update && sudo apt upgrade -y

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Ð¸ Docker Compose
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð°Ð²
sudo reboot
```

## ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸

```bash
# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
mkdir -p /opt/gospel-bot/{data,logs,config}
cd /opt/gospel-bot

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð°
sudo useradd -r -s /bin/false -d /opt/gospel-bot botuser
sudo chown -R botuser:botuser /opt/gospel-bot
```

---

# ðŸ—„ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Supabase RLS

## ðŸ” Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Row Level Security

### 1. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° RLS Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº

```sql
-- ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Supabase SQL Editor

-- Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ RLS Ð´Ð»Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ°: Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð²Ð¸Ð´ÑÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ
CREATE POLICY "Users can view own data" ON users
    FOR SELECT USING (auth.uid() = id::text OR telegram_id = current_setting('app.current_user_telegram_id')::bigint);

-- ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ°: Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¼Ð¾Ð³ÑƒÑ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ ÑÐ²Ð¾Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ
CREATE POLICY "Users can update own data" ON users
    FOR UPDATE USING (telegram_id = current_setting('app.current_user_telegram_id')::bigint);

-- ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ°: ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
CREATE POLICY "Allow user creation" ON users
    FOR INSERT WITH CHECK (true);

-- Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ RLS Ð´Ð»Ñ Ð·Ð°ÐºÐ»Ð°Ð´Ð¾Ðº
ALTER TABLE bookmarks ENABLE ROW LEVEL SECURITY;

-- ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ°: Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð²Ð¸Ð´ÑÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¸ Ð·Ð°ÐºÐ»Ð°Ð´ÐºÐ¸
CREATE POLICY "Users can view own bookmarks" ON bookmarks
    FOR ALL USING (user_id = (
        SELECT id FROM users WHERE telegram_id = current_setting('app.current_user_telegram_id')::bigint
    ));

-- Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ RLS Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ
ALTER TABLE user_reading_progress ENABLE ROW LEVEL SECURITY;

-- ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ°: Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð²Ð¸Ð´ÑÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¹ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ
CREATE POLICY "Users can view own progress" ON user_reading_progress
    FOR ALL USING (user_id = (
        SELECT id FROM users WHERE telegram_id = current_setting('app.current_user_telegram_id')::bigint
    ));

-- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ (Ð±ÐµÐ· RLS)
-- books, verses, themes, reading_plans, calendar_events
-- Ð­Ñ‚Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð²ÑÐµÐ¼ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ
```

### 2. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ

```sql
-- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
CREATE OR REPLACE FUNCTION set_current_user_telegram_id(telegram_id bigint)
RETURNS void AS $$
BEGIN
    PERFORM set_config('app.current_user_telegram_id', telegram_id::text, true);
END;
$$ LANGUAGE plpgsql;

-- ÐŸÑ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ
GRANT EXECUTE ON FUNCTION set_current_user_telegram_id TO anon, authenticated;
```

### 3. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Service Role

```sql
-- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€Ð¾Ð»Ð¸ Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð° Ñ Ð¿Ð¾Ð»Ð½Ñ‹Ð¼Ð¸ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸
-- Ð’ Supabase Dashboard -> Settings -> API
-- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ service_role key Ð´Ð»Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ð±Ð¾Ñ‚Ð°

-- Ð”Ð»Ñ Ð°Ð½Ð¾Ð½Ð¸Ð¼Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚ÐµÐ½Ð¸Ðµ ÑÐ¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð²)
GRANT SELECT ON books, verses, themes, reading_plans, calendar_events TO anon;
```

## ðŸ”§ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð° Ð±Ð¾Ñ‚Ð° Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ RLS

```python
# services/database.py
import asyncio
from supabase import create_client, Client
import logging

logger = logging.getLogger(__name__)

class SupabaseManager:
    def __init__(self, url: str, service_key: str):
        self.client: Client = create_client(url, service_key)
        
    async def set_user_context(self, telegram_id: int):
        """Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ RLS"""
        try:
            await asyncio.to_thread(
                self.client.rpc,
                'set_current_user_telegram_id',
                {'telegram_id': telegram_id}
            )
        except Exception as e:
            logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ {telegram_id}: {e}")
    
    async def add_user(self, telegram_id: int, username: str, first_name: str):
        """Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°"""
        try:
            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚
            await self.set_user_context(telegram_id)
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
            existing = await asyncio.to_thread(
                self.client.table('users')
                .select('id')
                .eq('telegram_id', telegram_id)
                .execute
            )
            
            if not existing.data:
                # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
                result = await asyncio.to_thread(
                    self.client.table('users')
                    .insert({
                        'telegram_id': telegram_id,
                        'username': username,
                        'first_name': first_name,
                        'created_at': 'now()',
                        'ai_usage_count': 0,
                        'ai_usage_date': 'CURRENT_DATE'
                    })
                    .execute
                )
                logger.info(f"Ð¡Ð¾Ð·Ð´Ð°Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ {telegram_id}")
                return result.data[0]
            else:
                return existing.data[0]
                
        except Exception as e:
            logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ {telegram_id}: {e}")
            raise
```

---

# âš™ï¸ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð±Ð¾Ñ‚Ð°

## ðŸ“„ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ docker-compose.yml

```yaml
# /opt/gospel-bot/docker-compose.yml
version: '3.8'

services:
  gospel-bot:
    image: probedrik/gospel-bot:latest
    container_name: gospel-bot-production
    restart: unless-stopped
    environment:
      # Telegram Bot
      - BOT_TOKEN=${BOT_TOKEN}
      
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      
      # OpenRouter AI
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_PREMIUM_API_KEY=${OPENROUTER_PREMIUM_API_KEY}
      
      # Analytics
      - GOOGLE_ANALYTICS_ID=${GOOGLE_ANALYTICS_ID}
      - MIXPANEL_TOKEN=${MIXPANEL_TOKEN}
      
      # Payment
      - YOOKASSA_SHOP_ID=${YOOKASSA_SHOP_ID}
      - YOOKASSA_SECRET_KEY=${YOOKASSA_SECRET_KEY}
      
      # Monitoring
      - SENTRY_DSN=${SENTRY_DSN}
      
      # Admin
      - ADMIN_USER_ID=${ADMIN_USER_ID}
      
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    
    networks:
      - gospel-bot-network
    
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=10)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx Ð´Ð»Ñ Ð²ÐµÐ±-Ñ…ÑƒÐºÐ¾Ð² (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
  nginx:
    image: nginx:alpine
    container_name: gospel-bot-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    networks:
      - gospel-bot-network
    depends_on:
      - gospel-bot

networks:
  gospel-bot-network:
    driver: bridge
```

## ðŸ” Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°

```bash
# /opt/gospel-bot/.env

# Telegram
BOT_TOKEN=your_bot_token_here
ADMIN_USER_ID=your_telegram_id

# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your_service_role_key_here

# OpenRouter
OPENROUTER_API_KEY=your_openrouter_key
OPENROUTER_PREMIUM_API_KEY=your_premium_key

# Analytics
GOOGLE_ANALYTICS_ID=G-XXXXXXXXXX
MIXPANEL_TOKEN=your_mixpanel_token

# Payment
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key

# Monitoring
SENTRY_DSN=https://your-sentry-dsn

# Security
chmod 600 .env
```

---

# ðŸ“Š ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸

## ðŸ“ˆ Google Analytics 4

### 1. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° GA4

```bash
# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Google Analytics ÑÐ²Ð¾Ð¹ÑÑ‚Ð²Ð°
1. Ð—Ð°Ð¹Ñ‚Ð¸ Ð² https://analytics.google.com
2. Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ð¾Ðµ ÑÐ²Ð¾Ð¹ÑÑ‚Ð²Ð¾
3. Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Enhanced Ecommerce
4. ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Measurement ID (G-XXXXXXXXXX)
```

### 2. Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð² Ð±Ð¾Ñ‚

```python
# services/analytics.py
import aiohttp
import asyncio
import logging
from typing import Dict, Any
import uuid
from datetime import datetime

logger = logging.getLogger(__name__)

class AnalyticsManager:
    def __init__(self, ga_measurement_id: str, ga_api_secret: str):
        self.ga_measurement_id = ga_measurement_id
        self.ga_api_secret = ga_api_secret
        self.ga_endpoint = f"https://www.google-analytics.com/mp/collect"
        
    async def track_event(self, user_id: int, event_name: str, parameters: Dict[str, Any] = None):
        """ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ Ð² Google Analytics"""
        if parameters is None:
            parameters = {}
            
        # Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
        base_params = {
            'user_id': str(user_id),
            'session_id': str(uuid.uuid4()),
            'timestamp_micros': int(datetime.now().timestamp() * 1000000)
        }
        
        # ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ñ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸
        parameters.update(base_params)
        
        payload = {
            'client_id': str(user_id),
            'events': [{
                'name': event_name,
                'params': parameters
            }]
        }
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(
                    self.ga_endpoint,
                    params={
                        'measurement_id': self.ga_measurement_id,
                        'api_secret': self.ga_api_secret
                    },
                    json=payload
                ) as response:
                    if response.status == 200:
                        logger.debug(f"GA event sent: {event_name}")
                    else:
                        logger.error(f"GA error: {response.status}")
        except Exception as e:
            logger.error(f"Analytics error: {e}")

# Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€
analytics = AnalyticsManager(
    ga_measurement_id=os.getenv('GOOGLE_ANALYTICS_ID'),
    ga_api_secret=os.getenv('GA_API_SECRET')
)
```

### 3. ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Ð² Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ°Ñ…

```python
# handlers/commands.py
from services.analytics import analytics

@router.message(Command("start"))
async def start_command(message: Message, state: FSMContext, db=None):
    user_id = message.from_user.id
    
    # ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð±Ð¾Ñ‚Ð°
    await analytics.track_event(
        user_id=user_id,
        event_name='bot_start',
        parameters={
            'platform': 'telegram',
            'user_type': 'new' if not await db.user_exists(user_id) else 'returning'
        }
    )
    
    # ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹...

# handlers/text_messages.py
@router.message(F.text == "ðŸ“– Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ ÐºÐ½Ð¸Ð³Ñƒ")
async def select_book(message: Message, state: FSMContext):
    user_id = message.from_user.id
    
    # ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð²Ñ‹Ð±Ð¾Ñ€Ð° ÐºÐ½Ð¸Ð³Ð¸
    await analytics.track_event(
        user_id=user_id,
        event_name='book_selection_started',
        parameters={
            'source': 'main_menu'
        }
    )

# handlers/ai_assistant.py
async def process_ai_request(message: Message, user_id: int, verses: list):
    # ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð˜Ð˜
    await analytics.track_event(
        user_id=user_id,
        event_name='ai_explanation_requested',
        parameters={
            'verses_count': len(verses),
            'ai_type': 'regular',  # Ð¸Ð»Ð¸ 'premium'
            'content_type': 'verse_explanation'
        }
    )
```

## ðŸ“Š Mixpanel Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ (Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð°)

```python
# services/mixpanel_analytics.py
import aiohttp
import base64
import json
import time

class MixpanelAnalytics:
    def __init__(self, token: str):
        self.token = token
        self.endpoint = "https://api.mixpanel.com/track"
    
    async def track(self, user_id: int, event: str, properties: dict = None):
        if properties is None:
            properties = {}
            
        properties.update({
            'token': self.token,
            'distinct_id': str(user_id),
            'time': int(time.time()),
            '$insert_id': f"{user_id}_{event}_{int(time.time())}"
        })
        
        data = {
            'event': event,
            'properties': properties
        }
        
        encoded_data = base64.b64encode(json.dumps(data).encode()).decode()
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(
                    self.endpoint,
                    data={'data': encoded_data}
                ) as response:
                    return response.status == 200
        except Exception as e:
            logger.error(f"Mixpanel error: {e}")
            return False
```

## ðŸ“ˆ Ð¡Ð¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð² Supabase

### 1. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸

```sql
-- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹
CREATE TABLE analytics_events (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    telegram_id BIGINT,
    event_name VARCHAR(100) NOT NULL,
    event_properties JSONB DEFAULT '{}',
    session_id UUID,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    user_agent TEXT,
    ip_address INET
);

-- Ð˜Ð½Ð´ÐµÐºÑÑ‹ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
CREATE INDEX idx_analytics_events_user_id ON analytics_events(user_id);
CREATE INDEX idx_analytics_events_event_name ON analytics_events(event_name);
CREATE INDEX idx_analytics_events_timestamp ON analytics_events(timestamp);
CREATE INDEX idx_analytics_events_telegram_id ON analytics_events(telegram_id);

-- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð´Ð»Ñ ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾Ð¹ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸
CREATE TABLE daily_stats (
    id SERIAL PRIMARY KEY,
    date DATE NOT NULL,
    total_users INTEGER DEFAULT 0,
    new_users INTEGER DEFAULT 0,
    active_users INTEGER DEFAULT 0,
    total_events INTEGER DEFAULT 0,
    ai_requests INTEGER DEFAULT 0,
    bookmarks_created INTEGER DEFAULT 0,
    UNIQUE(date)
);
```

### 2. Ð¡ÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÐµÐ¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸

```python
# services/internal_analytics.py
from supabase import Client
import asyncio
from datetime import datetime, date
import uuid
import logging

logger = logging.getLogger(__name__)

class InternalAnalytics:
    def __init__(self, supabase: Client):
        self.supabase = supabase
        
    async def track_event(
        self, 
        telegram_id: int, 
        event_name: str, 
        properties: dict = None,
        session_id: str = None
    ):
        """ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ Ð²Ð¾ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÐµÐ¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐµ"""
        if properties is None:
            properties = {}
            
        if session_id is None:
            session_id = str(uuid.uuid4())
            
        try:
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
            user_result = await asyncio.to_thread(
                self.supabase.table('users')
                .select('id')
                .eq('telegram_id', telegram_id)
                .execute
            )
            
            user_id = user_result.data[0]['id'] if user_result.data else None
            
            # Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ
            await asyncio.to_thread(
                self.supabase.table('analytics_events')
                .insert({
                    'user_id': user_id,
                    'telegram_id': telegram_id,
                    'event_name': event_name,
                    'event_properties': properties,
                    'session_id': session_id,
                    'timestamp': datetime.now().isoformat()
                })
                .execute
            )
            
            logger.debug(f"Internal analytics: {event_name} for user {telegram_id}")
            
        except Exception as e:
            logger.error(f"Internal analytics error: {e}")
    
    async def get_daily_stats(self, days: int = 30) -> list:
        """ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ N Ð´Ð½ÐµÐ¹"""
        try:
            result = await asyncio.to_thread(
                self.supabase.table('daily_stats')
                .select('*')
                .order('date', desc=True)
                .limit(days)
                .execute
            )
            return result.data
        except Exception as e:
            logger.error(f"Error getting daily stats: {e}")
            return []
    
    async def update_daily_stats(self):
        """ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾Ð¹ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸"""
        today = date.today()
        
        try:
            # ÐžÐ±Ñ‰ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
            total_users = await asyncio.to_thread(
                self.supabase.table('users')
                .select('id', count='exact')
                .execute
            )
            
            # ÐÐ¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ
            new_users = await asyncio.to_thread(
                self.supabase.table('users')
                .select('id', count='exact')
                .gte('created_at', today.isoformat())
                .execute
            )
            
            # ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ
            active_users = await asyncio.to_thread(
                self.supabase.table('analytics_events')
                .select('telegram_id', count='exact')
                .gte('timestamp', today.isoformat())
                .execute
            )
            
            # Ð˜Ð˜ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ
            ai_requests = await asyncio.to_thread(
                self.supabase.table('analytics_events')
                .select('id', count='exact')
                .eq('event_name', 'ai_explanation_requested')
                .gte('timestamp', today.isoformat())
                .execute
            )
            
            # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð·Ð° Ð´ÐµÐ½ÑŒ
            await asyncio.to_thread(
                self.supabase.table('daily_stats')
                .upsert({
                    'date': today.isoformat(),
                    'total_users': total_users.count,
                    'new_users': new_users.count,
                    'active_users': active_users.count,
                    'ai_requests': ai_requests.count
                })
                .execute
            )
            
        except Exception as e:
            logger.error(f"Error updating daily stats: {e}")
```

### 3. Middleware Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ

```python
# middleware/analytics_middleware.py
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject, Message, CallbackQuery
from services.internal_analytics import InternalAnalytics
import uuid

class AnalyticsMiddleware(BaseMiddleware):
    def __init__(self, analytics: InternalAnalytics):
        self.analytics = analytics
        super().__init__()

    async def __call__(
        self,
        handler,
        event: TelegramObject,
        data: dict
    ):
        # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ session_id Ð´Ð»Ñ ÑÐµÑÑÐ¸Ð¸
        if 'session_id' not in data:
            data['session_id'] = str(uuid.uuid4())
            
        # ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
        if isinstance(event, Message):
            await self._track_message(event, data['session_id'])
        elif isinstance(event, CallbackQuery):
            await self._track_callback(event, data['session_id'])
            
        return await handler(event, data)
    
    async def _track_message(self, message: Message, session_id: str):
        """ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹"""
        properties = {
            'message_type': 'text' if message.text else 'other',
            'chat_type': message.chat.type,
            'has_reply': bool(message.reply_to_message)
        }
        
        if message.text:
            if message.text.startswith('/'):
                event_name = 'command_used'
                properties['command'] = message.text.split()[0]
            else:
                event_name = 'message_sent'
                properties['text_length'] = len(message.text)
        else:
            event_name = 'media_sent'
            
        await self.analytics.track_event(
            telegram_id=message.from_user.id,
            event_name=event_name,
            properties=properties,
            session_id=session_id
        )
    
    async def _track_callback(self, callback: CallbackQuery, session_id: str):
        """ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ð¹ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÐ¸"""
        properties = {
            'callback_data': callback.data,
            'message_id': callback.message.message_id
        }
        
        await self.analytics.track_event(
            telegram_id=callback.from_user.id,
            event_name='button_clicked',
            properties=properties,
            session_id=session_id
        )
```

---

# ðŸ“Š ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¸ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

## ðŸ“ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

```python
# config/logging_config.py
import logging
import logging.handlers
import os
from datetime import datetime

def setup_logging():
    """ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ"""
    
    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
    log_dir = '/app/logs'
    os.makedirs(log_dir, exist_ok=True)
    
    # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‚ÐµÑ€Ð°
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    
    # ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð»Ð¾Ð³Ð³ÐµÑ€
    logger = logging.getLogger()
    logger.setLevel(logging.INFO)
    
    # Ð¤Ð°Ð¹Ð»Ð¾Ð²Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ñ Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸ÐµÐ¹
    file_handler = logging.handlers.RotatingFileHandler(
        f'{log_dir}/bot.log',
        maxBytes=10*1024*1024,  # 10MB
        backupCount=5
    )
    file_handler.setFormatter(formatter)
    logger.addHandler(file_handler)
    
    # ÐžÑ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð»Ð¾Ð³ Ð´Ð»Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
    error_handler = logging.handlers.RotatingFileHandler(
        f'{log_dir}/errors.log',
        maxBytes=10*1024*1024,
        backupCount=5
    )
    error_handler.setLevel(logging.ERROR)
    error_handler.setFormatter(formatter)
    logger.addHandler(error_handler)
    
    # ÐšÐ¾Ð½ÑÐ¾Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ‹Ð²Ð¾Ð´
    console_handler = logging.StreamHandler()
    console_handler.setFormatter(formatter)
    logger.addHandler(console_handler)
    
    return logger
```

## ðŸ” Sentry Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº

```python
# services/sentry_config.py
import sentry_sdk
from sentry_sdk.integrations.logging import LoggingIntegration
import os

def setup_sentry():
    """ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Sentry Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº"""
    sentry_dsn = os.getenv('SENTRY_DSN')
    
    if sentry_dsn:
        sentry_logging = LoggingIntegration(
            level=logging.INFO,
            event_level=logging.ERROR
        )
        
        sentry_sdk.init(
            dsn=sentry_dsn,
            integrations=[sentry_logging],
            traces_sample_rate=0.1,
            environment="production"
        )
```

## ðŸ“ˆ Health Check ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚

```python
# health_check.py
from aiohttp import web
import asyncio
import logging
from services.database import db

logger = logging.getLogger(__name__)

async def health_check(request):
    """ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°"""
    try:
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð‘Ð”
        await db.execute_query("SELECT 1")
        
        return web.json_response({
            'status': 'healthy',
            'timestamp': datetime.now().isoformat(),
            'services': {
                'database': 'ok',
                'bot': 'running'
            }
        })
    except Exception as e:
        logger.error(f"Health check failed: {e}")
        return web.json_response({
            'status': 'unhealthy',
            'error': str(e)
        }, status=500)

# Ð—Ð°Ð¿ÑƒÑÐº Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€Ð° Ð´Ð»Ñ health check
async def start_health_server():
    app = web.Application()
    app.router.add_get('/health', health_check)
    
    runner = web.AppRunner(app)
    await runner.setup()
    
    site = web.TCPSite(runner, '0.0.0.0', 8000)
    await site.start()
    logger.info("Health check server started on port 8000")
```

---

# ðŸ’¾ Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

## ðŸ“‹ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð±ÑÐºÐ°Ð¿Ð° Supabase

```bash
#!/bin/bash
# /opt/gospel-bot/scripts/backup.sh

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
BACKUP_DIR="/opt/gospel-bot/backups"
DATE=$(date +%Y%m%d_%H%M%S)
SUPABASE_PROJECT_ID="your_project_id"
SUPABASE_DB_PASSWORD="your_db_password"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð±ÑÐºÐ°Ð¿Ð¾Ð²
mkdir -p $BACKUP_DIR

# Ð‘ÑÐºÐ°Ð¿ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo "Starting database backup..."
pg_dump -h db.${SUPABASE_PROJECT_ID}.supabase.co \
        -U postgres \
        -W \
        -d postgres \
        --no-owner \
        --no-privileges \
        -f ${BACKUP_DIR}/database_backup_${DATE}.sql

# Ð¡Ð¶Ð°Ñ‚Ð¸Ðµ Ð±ÑÐºÐ°Ð¿Ð°
gzip ${BACKUP_DIR}/database_backup_${DATE}.sql

# Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð±ÑÐºÐ°Ð¿Ð¾Ð² (ÑÑ‚Ð°Ñ€ÑˆÐµ 30 Ð´Ð½ÐµÐ¹)
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete

echo "Backup completed: database_backup_${DATE}.sql.gz"

# ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð² Ð¾Ð±Ð»Ð°ÐºÐ¾ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
# aws s3 cp ${BACKUP_DIR}/database_backup_${DATE}.sql.gz s3://your-bucket/backups/
```

## â° ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° cron Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð±ÑÐºÐ°Ð¿Ð¾Ð²

```bash
# Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð² crontab
crontab -e

# Ð‘ÑÐºÐ°Ð¿ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 2:00 Ð½Ð¾Ñ‡Ð¸
0 2 * * * /opt/gospel-bot/scripts/backup.sh >> /opt/gospel-bot/logs/backup.log 2>&1

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð»Ð¾Ð³Ð¾Ð² ÐºÐ°Ð¶Ð´ÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ
0 0 * * 0 find /opt/gospel-bot/logs -name "*.log" -mtime +7 -delete
```

---

# ðŸ”’ Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ

## ðŸ›¡ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°

```bash
# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° UFW
sudo apt install ufw

# Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ SSH
sudo ufw allow ssh

# Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ HTTP/HTTPS (ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ webhook)
sudo ufw allow 80
sudo ufw allow 443

# ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°
sudo ufw enable
```

## ðŸ” SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ (ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ webhook)

```bash
# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Certbot
sudo apt install certbot

# ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
sudo certbot certonly --standalone -d your-domain.com

# ÐÐ²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

## ðŸ“‹ Ð§ÐµÐº-Ð»Ð¸ÑÑ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸

- [ ] Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ environment Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
- [ ] ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°
- [ ] Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
- [ ] ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð»Ð¾Ð³Ð¾Ð² Ð½Ð° Ð¿Ð¾Ð´Ð¾Ð·Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½ÑƒÑŽ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ
- [ ] ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð±Ð¾Ñ‚Ð°
- [ ] Ð¨Ð¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Ð‘Ð”
- [ ] ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° rate limiting
- [ ] Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

---

# ðŸš€ Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

## ðŸ“ ÐŸÐ¾ÑˆÐ°Ð³Ð¾Ð²Ð¾Ðµ Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ð¾

### 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÑÐµÑ… Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
cd /opt/gospel-bot
cat .env | grep -v "^#" | grep -v "^$"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker
docker --version
docker-compose --version
```

### 2. Ð—Ð°Ð¿ÑƒÑÐº Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½

```bash
# Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¾Ð±Ñ€Ð°Ð·Ð°
docker-compose pull

# Ð—Ð°Ð¿ÑƒÑÐº Ð² Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ
docker-compose up -d

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð²
docker-compose logs -f gospel-bot

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° health check
curl http://localhost:8000/health
```

### 3. ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
docker-compose ps

# ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
docker stats gospel-bot-production

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð² Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
tail -f /opt/gospel-bot/logs/bot.log
```

### 4. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°

```bash
# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°
sudo tee /etc/systemd/system/gospel-bot.service > /dev/null <<EOF
[Unit]
Description=Gospel Bot
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/gospel-bot
ExecStart=/usr/local/bin/docker-compose up -d
ExecStop=/usr/local/bin/docker-compose down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
EOF

# ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ð²Ð¸ÑÐ°
sudo systemctl enable gospel-bot.service
sudo systemctl start gospel-bot.service
```

---

## âœ… Ð§ÐµÐº-Ð»Ð¸ÑÑ‚ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Ðº Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ñƒ

### Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚ÑŒ:
- [ ] VPS Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½
- [ ] Docker Ð¸ Docker Compose ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹
- [ ] Ð¡Ð¾Ð·Ð´Ð°Ð½Ñ‹ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
- [ ] ÐÐ°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°

### Supabase:
- [ ] RLS Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹ Ð¸ Ð¿Ñ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹
- [ ] Ð¢Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹
- [ ] Service Role ÐºÐ»ÑŽÑ‡ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½
- [ ] ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð” Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚

### ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ:
- [ ] .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½
- [ ] docker-compose.yml Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½
- [ ] Ð’ÑÐµ API ÐºÐ»ÑŽÑ‡Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚
- [ ] ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ñ‹

### ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ°:
- [ ] Google Analytics Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½
- [ ] Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°
- [ ] Middleware Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½
- [ ] Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑŽÑ‚ÑÑ

### ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³:
- [ ] Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾
- [ ] Sentry Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½
- [ ] Health check Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
- [ ] ÐÐ»ÐµÑ€Ñ‚Ñ‹ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹

### Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ:
- [ ] Ð¤Ð°Ð¹Ñ€Ð²Ð¾Ð» Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½
- [ ] SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶ÐµÐ½)
- [ ] ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ñ‹
- [ ] Ð¡ÐµÐºÑ€ÐµÑ‚Ñ‹ Ð·Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ñ‹

### Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:
- [ ] Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð±ÑÐºÐ°Ð¿Ð° ÑÐ¾Ð·Ð´Ð°Ð½
- [ ] Cron Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹
- [ ] Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð±ÑÐºÐ°Ð¿ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½
- [ ] Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾

---

*ÐŸÐ¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð²ÑÐµÑ… ÑˆÐ°Ð³Ð¾Ð² Ð²Ð°Ñˆ Ð±Ð¾Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ðµ Ñ Ð¿Ð¾Ð»Ð½Ñ‹Ð¼ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð¾Ð¼, Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¾Ð¹ Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¾Ð¹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸!*

