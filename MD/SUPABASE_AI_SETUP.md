# üöÄ –ù–ê–°–¢–†–û–ô–ö–ê SUPABASE –î–õ–Ø –°–ò–°–¢–ï–ú–´ –ò–ò

## üéØ –û–±–∑–æ—Ä

–í—Å–µ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ò–ò –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å Supabase –∏ –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ.

## üìã –®–∞–≥–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### 1. üóÑÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ Supabase

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç –≤ Supabase SQL Editor:**

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `database/supabase_ai_settings_migration.sql` –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ –≤ –≤–∞—à–µ–º Supabase –ø—Ä–æ–µ–∫—Ç–µ.

**–ß—Ç–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è:**
- ‚úÖ `ai_settings` - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–ò
- ‚úÖ `premium_requests` - –ø—Ä–µ–º–∏—É–º –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ `premium_purchases` - –∏—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫
- ‚úÖ `donations` - –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `updated_at`
- ‚úÖ Row Level Security (RLS) –ø–æ–ª–∏—Ç–∏–∫–∏

### 2. ‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `.env` —Ñ–∞–π–ª–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:**

```env
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Supabase
USE_SUPABASE=true

# Supabase –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-service-role-key

# –ò–ò –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
OPENROUTER_API_KEY=your_openrouter_key
OPENROUTER_PREMIUM_API_KEY=your_premium_openrouter_key
OPENROUTER_PREMIUM_MODEL=anthropic/claude-3.5-sonnet

# –ÆKassa (–¥–ª—è –±—É–¥—É—â–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π)
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key
YOOKASSA_WEBHOOK_SECRET=your_webhook_secret
```

### 3. üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

**–í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ `SupabaseManager`:**

```python
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–ò
await db_manager.get_ai_setting('ai_daily_limit')
await db_manager.set_ai_setting('ai_daily_limit', '5', 'integer')
await db_manager.get_all_ai_settings()

# –ü—Ä–µ–º–∏—É–º –∑–∞–ø—Ä–æ—Å—ã
await db_manager.get_user_premium_requests(user_id)
await db_manager.add_premium_requests(user_id, 50)
await db_manager.use_premium_request(user_id)
await db_manager.get_premium_stats(user_id)

# –ü–æ–∫—É–ø–∫–∏ –∏ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è
await db_manager.create_premium_purchase(user_id, 50, 100, payment_id)
await db_manager.complete_premium_purchase(payment_id)
await db_manager.create_donation(user_id, 100, payment_id, message)
await db_manager.complete_donation(payment_id)
```

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

**–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞:**

1. `UniversalDatabaseManager` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Supabase
2. –°–æ–∑–¥–∞–µ—Ç—Å—è `SupabaseManager` —Å –º–µ—Ç–æ–¥–∞–º–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
3. –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã (`AISettingsManager`, `PremiumManager`) —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π API

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:

```python
# –í Python –∫–æ–Ω—Å–æ–ª–∏ –∏–ª–∏ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–∫—Ä–∏–ø—Ç–µ
from database.universal_manager import universal_db_manager

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –º–µ–Ω–µ–¥–∂–µ—Ä–∞
print(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Supabase: {universal_db_manager.is_supabase}")

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–ò
settings = await universal_db_manager.get_all_ai_settings()
print(f"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–ò: {settings}")

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–µ–º–∏—É–º –∑–∞–ø—Ä–æ—Å—ã
premium_count = await universal_db_manager.get_user_premium_requests(123456789)
print(f"–ü—Ä–µ–º–∏—É–º –∑–∞–ø—Ä–æ—Å—ã: {premium_count}")
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å:

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: `python bot.py`
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/admin`
3. –ù–∞–∂–º–∏—Ç–µ **‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–ò**
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
5. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Supabase

### –¢–∞–±–ª–∏—Ü–∞ `ai_settings`:
```sql
id | setting_key | setting_value | setting_type | description | created_at | updated_at
1  | ai_daily_limit | 3 | integer | –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç... | 2024-01-15 | 2024-01-15
2  | premium_package_price | 100 | integer | –¶–µ–Ω–∞ –ø—Ä–µ–º–∏—É–º... | 2024-01-15 | 2024-01-15
```

### –¢–∞–±–ª–∏—Ü–∞ `premium_requests`:
```sql
id | user_id | requests_count | total_purchased | total_used | created_at | updated_at
1  | 123456789 | 25 | 50 | 25 | 2024-01-15 | 2024-01-15
```

### –¢–∞–±–ª–∏—Ü–∞ `premium_purchases`:
```sql
id | user_id | requests_count | amount_rub | payment_id | payment_status | created_at | completed_at
1  | 123456789 | 50 | 100 | pay_123 | completed | 2024-01-15 | 2024-01-15
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Row Level Security (RLS):

–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞—â–∏—â–µ–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏:
- –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è service role
- –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ service role key** –¥–ª—è –±–æ—Ç–∞ (–Ω–µ anon key)
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏** –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
3. **–†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –∫–ª—é—á–∏** –¥–æ—Å—Ç—É–ø–∞
4. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** —á–µ—Ä–µ–∑ Supabase Dashboard

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Supabase:

- ‚úÖ **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–ò** - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
- ‚úÖ **–ü—Ä–µ–º–∏—É–º –∑–∞–ø—Ä–æ—Å—ã** - –ø–æ–∫—É–ø–∫–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- ‚úÖ **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ **–†–µ–∂–∏–º –ò–ò –¥–ª—è –∞–¥–º–∏–Ω–∞** - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –æ–±—ã—á–Ω—ã–º/–ø—Ä–µ–º–∏—É–º
- ‚úÖ **–ü–æ–∫—É–ø–∫–∏ –∏ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è** - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ÆKassa
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** - –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### üîÑ Fallback –¥–ª—è SQLite:

–ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ SQLite —Å —Ç–µ–º–∏ –∂–µ —Ñ—É–Ω–∫—Ü–∏—è–º–∏.

## üéØ –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –¥–ª—è Supabase!

–í—Å–µ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ò–ò —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞—Ç–∏–≤–Ω–æ —Å Supabase —á–µ—Ä–µ–∑ Python SDK –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫.