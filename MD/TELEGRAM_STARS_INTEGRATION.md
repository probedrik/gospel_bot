# üåü –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Stars

## üìã –ß—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ

### ‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "‚≠ê Telegram Stars" –≤ –º–µ–Ω—é –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π
- –°–æ–∑–¥–∞–Ω–æ –º–µ–Ω—é –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—É–º–º—ã Stars (10, 25, 50, 100, 250, 500)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–ø—Ü–∏—è "üåü –ö—É–ø–∏—Ç—å –∑–∞ Telegram Stars" –≤ –º–µ–Ω—é –ø—Ä–µ–º–∏—É–º–∞
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–∞–∫–µ—Ç—ã –ø—Ä–µ–º–∏—É–º –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ Stars:
  - 10 –∑–∞–ø—Ä–æ—Å–æ–≤ = 25 Stars (2.5 Stars –∑–∞ –∑–∞–ø—Ä–æ—Å)
  - 25 –∑–∞–ø—Ä–æ—Å–æ–≤ = 50 Stars (2.0 Stars –∑–∞ –∑–∞–ø—Ä–æ—Å)
  - 50 –∑–∞–ø—Ä–æ—Å–æ–≤ = 100 Stars (2.0 Stars –∑–∞ –∑–∞–ø—Ä–æ—Å)
  - 100 –∑–∞–ø—Ä–æ—Å–æ–≤ = 180 Stars (1.8 Stars –∑–∞ –∑–∞–ø—Ä–æ—Å) üíé

### ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–∞–±–ª–∏—Ü—ã `premium_purchases` –∏ `donations` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Stars
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `star_transactions` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### ‚úÖ –ë—ç–∫–µ–Ω–¥
- –†–∞—Å—à–∏—Ä–µ–Ω `PremiumManager` –º–µ—Ç–æ–¥–∞–º–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Stars:
  - `create_star_donation()` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Stars
  - `create_star_premium_purchase()` - –ø–æ–∫—É–ø–∫–∞ –ø—Ä–µ–º–∏—É–º–∞ –∑–∞ Stars
  - `get_user_star_transactions()` - –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
  - `verify_star_transaction()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

### ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ä—É–±–ª–µ–≤—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤—ã–±–∏—Ä–∞—Ç—å –º–µ–∂–¥—É Stars –∏ —Ä—É–±–ª—è–º–∏

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–¥–µ–ª–∞—Ç—å –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Bot API –¥–ª—è Stars
–í aiogram 3.19+ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Telegram Stars —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑:

```python
from aiogram.types import LabeledPrice

# –ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞ –¥–ª—è Stars
await bot.send_invoice(
    chat_id=user_id,
    title="–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç—É",
    description="–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ —Ä–∞–∑–≤–∏—Ç–∏–µ –±–∏–±–ª–µ–π—Å–∫–æ–≥–æ –±–æ—Ç–∞",
    payload="donation_stars_50",
    provider_token="",  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è Telegram Stars
    currency="XTR",     # –í–∞–ª—é—Ç–∞ Telegram Stars
    prices=[LabeledPrice(label="–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ", amount=50)],  # amount –≤ Stars
    # –î—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã...
)
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π Stars
–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è `successful_payment` –∏ `pre_checkout_query`:

```python
from aiogram.types import SuccessfulPayment, PreCheckoutQuery

@router.pre_checkout_query()
async def process_pre_checkout_query(query: PreCheckoutQuery):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º Stars"""
    if query.currency == "XTR":  # Telegram Stars
        await query.answer(ok=True)
    else:
        await query.answer(ok=False, error_message="Unsupported currency")

@router.message(F.successful_payment)
async def process_successful_payment(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞"""
    payment = message.successful_payment
    
    if payment.currency == "XTR":  # Telegram Stars
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ payload
        payload_parts = payment.invoice_payload.split("_")
        
        if payload_parts[0] == "donation":
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è
            stars_amount = int(payload_parts[2])
            await premium_manager.create_star_donation(
                user_id=message.from_user.id,
                amount_stars=stars_amount,
                telegram_payment_charge_id=payment.telegram_payment_charge_id
            )
        
        elif payload_parts[0] == "premium":
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∫—É–ø–∫–∏ –ø—Ä–µ–º–∏—É–º–∞
            requests_count = int(payload_parts[2])
            stars_amount = int(payload_parts[3])
            await premium_manager.create_star_premium_purchase(
                user_id=message.from_user.id,
                requests_count=requests_count,
                amount_stars=stars_amount,
                telegram_payment_charge_id=payment.telegram_payment_charge_id
            )
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–Ω–æ–ø–æ–∫
–ó–∞–º–µ–Ω–∏—Ç—å TODO –≤ `handlers/settings.py`:

```python
@router.callback_query(F.data.startswith("donate_stars_"))
async def process_stars_donation(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π —á–µ—Ä–µ–∑ Telegram Stars"""
    data_parts = callback.data.split("_")
    
    if len(data_parts) >= 3:
        stars_amount = int(data_parts[2])
        
        await callback.message.bot.send_invoice(
            chat_id=callback.from_user.id,
            title="–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç—É",
            description=f"–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–≤–∏—Ç–∏—è –±–∏–±–ª–µ–π—Å–∫–æ–≥–æ –±–æ—Ç–∞ - {stars_amount} Stars",
            payload=f"donation_stars_{stars_amount}",
            provider_token="",  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è Stars
            currency="XTR",
            prices=[LabeledPrice(label="–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ", amount=stars_amount)],
            need_name=False,
            need_phone_number=False,
            need_email=False,
            need_shipping_address=False,
            send_phone_number_to_provider=False,
            send_email_to_provider=False,
            is_flexible=False
        )
        
        await callback.answer("üí´ –°–æ–∑–¥–∞–Ω –∏–Ω–≤–æ–π—Å –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Telegram Stars!")
```

### 4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–î–æ–±–∞–≤–∏—Ç—å –≤ `.env` –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è):

```env
# Telegram Stars (–æ–±—ã—á–Ω–æ —Ç–æ–∫–µ–Ω –Ω–µ –Ω—É–∂–µ–Ω, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
TELEGRAM_STARS_ENABLED=true
TELEGRAM_STARS_MIN_AMOUNT=1
TELEGRAM_STARS_MAX_AMOUNT=2500
```

## üöÄ –ó–∞–ø—É—Å–∫ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

1. **–û–±–Ω–æ–≤–∏—Ç–µ aiogram**: `pip install aiogram>=3.19.0`
2. **–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –ë–î**: –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ `database/premium_requests_schema.sql`
3. **–î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π**: –†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø—É–Ω–∫—Ç—ã 2-3 –≤—ã—à–µ
4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ**: –ù–∞—á–Ω–∏—Ç–µ —Å –Ω–µ–±–æ–ª—å—à–∏—Ö —Å—É–º–º Stars
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É `star_transactions`

## üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Telegram Stars

- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –ù–∏–∫–∞–∫–∏—Ö –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
- ‚úÖ **–°–∫–æ—Ä–æ—Å—Ç—å**: –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –í—Å—Ç—Ä–æ–µ–Ω–æ –≤ Telegram
- ‚úÖ **–ê–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å**: –ù–µ –Ω—É–∂–Ω—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ **–ù–∏–∑–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏**: Telegram –±–µ—Ä–µ—Ç –º–µ–Ω—å—à–µ, —á–µ–º –±–∞–Ω–∫–∏
- ‚úÖ **–ì–ª–æ–±–∞–ª—å–Ω–æ—Å—Ç—å**: –†–∞–±–æ—Ç–∞–µ—Ç –≤–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∞—Ö –≥–¥–µ –µ—Å—Ç—å Telegram

## üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:

```python
@router.message(Command("stars_stats"))
async def stars_statistics(message: Message):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ Telegram Stars (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)"""
    if message.from_user.id != ADMIN_USER_ID:
        return
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    stats = await premium_manager.get_star_transactions_stats()
    
    stats_text = (
        "üåü **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Telegram Stars**\n\n"
        f"üìä **–í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**: {stats['total_transactions']}\n"
        f"üí∞ **–û–±—â–∞—è —Å—É–º–º–∞**: {stats['total_stars']} Stars\n"
        f"üéÅ **–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è**: {stats['donations_count']} ({stats['donations_stars']} Stars)\n"
        f"‚≠ê **–ü—Ä–µ–º–∏—É–º –ø–æ–∫—É–ø–∫–∏**: {stats['premium_count']} ({stats['premium_stars']} Stars)\n"
        f"üìà **–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π**: {stats['week_transactions']} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π\n"
    )
    
    await message.answer(stats_text, parse_mode="Markdown")
```

---

## ‚úÖ –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê!

### üöÄ –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ

**–ß—Ç–æ –≥–æ—Ç–æ–≤–æ:**
- ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Telegram Stars –≤ `handlers/payments.py`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –æ–ø—Ü–∏—è–º–∏ Stars
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Stars —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏  
- ‚úÖ –ü—Ä–µ–º–∏—É–º —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Stars –∏ —Ä—É–±–ª—è–º–∏
- ‚úÖ –ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è –ø—Ä–∏–Ω–∏–º–∞—é—Ç Stars –∏ —Ä—É–±–ª–∏
- ‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã (aiogram 3.21.0)

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç "üí∞ –ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è" ‚Üí "‚≠ê Telegram Stars"
2. –í—ã–±–∏—Ä–∞–µ—Ç —Å—É–º–º—É Stars (10, 25, 50, 100, 250, 500)
3. Telegram –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç native Stars payment UI
4. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î –∏ –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç

**–ü—Ä–µ–º–∏—É–º —á–µ—Ä–µ–∑ Stars:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç "‚≠ê –ü—Ä–µ–º–∏—É–º –ò–ò" ‚Üí "üåü –ö—É–ø–∏—Ç—å –∑–∞ Telegram Stars"  
2. –í—ã–±–∏—Ä–∞–µ—Ç –ø–∞–∫–µ—Ç (10/25/50/100 –∑–∞–ø—Ä–æ—Å–æ–≤)
3. –û–ø–ª–∞—á–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ Telegram Stars
4. –ó–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫ –±–∞–ª–∞–Ω—Å—É

**–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
- –†—É–±–ª–µ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ –ÆKassa —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤—ã–±–∏—Ä–∞—Ç—å —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–¥–Ω–æ–π –ë–î —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ –¥–ª—è —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–∂–∞

### üéâ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é!

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Telegram Stars –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π.

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ production (Stars –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Ç–µ—Å—Ç–µ)
- –ù–∞—á–Ω–∏—Ç–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö —Å—É–º–º
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–ª–∞—Ç–µ–∂–∏ –≤–∫–ª—é—á–µ–Ω—ã –≤ BotFather